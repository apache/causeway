One can setup a gitlab repository just for the purpose of 
building and deploying _Causeway_ artifacts.

== Gitlab Runner Configuration

[source,yaml]
.config.toml
----
[[runners]]
...
output_limit -> limits the max output log size of the build, defaults to (4096) 4MB, we recommend 10000
----

see also https://docs.gitlab.com/runner/configuration/advanced-configuration/

== Pipeline Definition

A build script could look like:

[source,yaml]
..gitlab-ci.yml
----
spec:
  inputs:
    revision:
      type: string
      description: "the Maven revision (artifact version) that we are building; defaults to 2.2.0-SNAPSHOT"
      default: "2.2.0-SNAPSHOT"
    commit_or_branch:
      type: string
      description: "the commit-hash or branch name to check out; defaults to maintenance-branch"
      default: maintenance-branch
    java_target_version:
      type: number
      options: [11, 17, 21, 25]
      description: "targeted Java compile version; defaults to 11"
      default: 11
    test_or_deploy:
       type: string
       options: ['test', 'deploy']
       default: 'test'
       description: "whether to just 'test' or also 'deploy' : defaults to 'test'"
    are_you_sure:
      type: string
      options: ['yes', 'no']
      default: 'no'
      description: "only 'yes' triggers the pipeline"
---   

image: maven:3.9.12-eclipse-temurin-25

variables:
  CAN_RUN: $[[ inputs.are_you_sure ]]
  REVISION: $[[ inputs.revision ]]
  COMMIT_OR_BRANCH: $[[ inputs.commit_or_branch ]]
  JAVA_TARGET_VERSION: $[[ inputs.java_target_version ]]
  TEST_OR_DEPLOY: $[[ inputs.test_or_deploy ]]

# Define the workflow which specifies that the entire pipeline should only be triggered manually
workflow:
  rules:
    - if: $CAN_RUN == "yes"
      when: always  # Triggers the pipeline
    - when: never  # Do not run the pipeline if the condition is not met

stages:          # List of stages for jobs, and their order of execution
  - checkout
  - rename
  - test
  - deploy
  
include:
  - local: ci/checkout-v2.yml
  - local: ci/test-and-deploy-causeway-v2.yml
  - local: ci/test-and-deploy-isis-v2.yml
----

where the actual jobs are declared in their own files in the `ci` directory: 

- `ci/checkout-v2.yml`
- `ci/test-and-deploy-causeway-v2.yml`
- `ci/test-and-deploy-isis-v2.yml`

For the below deployment jobs to work, we are using a 
custom:

- `ci/m2-settings.xml`

== Deployment Configuration

The following exemplifies deployment to a _Nexus_ instance, using `https://nexus.example.com:PORT/` as a placeholder for you to fill in.
Also `NEXUS_DEPLOYMENT_PASS` is used as the secret required for authenticating the user `development` against the _Nexus_ instance. 
Usually to be configured at the gitlab's project page under `CI/CD Settings` -> `Variables`. 

[source,xml]
.ci/m2-settings.xml
----
<settings xmlns="http://maven.apache.org/SETTINGS/1.1.0"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.1.0 http://maven.apache.org/xsd/settings-1.1.0.xsd">
    
    <servers>
        <server>
            <id>internal.repo.releases</id>
            <username>deployment</username>
            <password>${env.NEXUS_DEPLOYMENT_PASS}</password>
        </server>
        <server>
            <id>internal.repo.snapshots</id>
            <username>deployment</username>
            <password>${env.NEXUS_DEPLOYMENT_PASS}</password>
        </server>
    </servers>
    
    <profiles>
        <profile>
            <id>internal.repo</id>
            <activation>
                <property>
                    <name>internal.repo</name>
                </property>
            </activation>
            <properties>
                <!-- your nexus urls here -->
                <altReleaseDeploymentRepository>internal.repo.releases::https://nexus.example.com:PORT/repository/maven-releases/</altReleaseDeploymentRepository>
                <altSnapshotDeploymentRepository>internal.repo.snapshots::https://nexus.example.com:PORT/repository/maven-snapshots/</altSnapshotDeploymentRepository>
            </properties>
            <repositories>
                <repository>
                    <id>internal.repo.group</id>
                    <name>nexus@example</name>
                    <!-- your nexus url here -->
                    <url>https://nexus.example.com:PORT/repository/maven-group/</url>
                    <releases>
                        <enabled>true</enabled>
                        <updatePolicy>always</updatePolicy>
                        <checksumPolicy>fail</checksumPolicy>
                    </releases>
                    <snapshots>
                        <enabled>true</enabled>
                        <updatePolicy>always</updatePolicy>
                        <checksumPolicy>fail</checksumPolicy>
                    </snapshots>
                </repository>
            </repositories>
        </profile>
    </profiles>
    
    <activeProfiles>
        <activeProfile>internal.repo</activeProfile>
    </activeProfiles>

    <!-- optionally allows deployment to HTTP (non HTTPS) repo, use at your own risk! -->
    <mirrors>
        <!-- a copy of /opt/maven/conf/settings.xml, so can override with exception rules -->
        <mirror>
          <id>maven-default-http-blocker</id>
          <mirrorOf>!internal.repo.group,external:http:*</mirrorOf>
          <name>Pseudo repository to mirror external repositories initially using HTTP.</name>
          <url>http://0.0.0.0/</url>
          <blocked>true</blocked>
        </mirror>
    </mirrors>

</settings>
----

== Checkout and set Version/Revision

Generates a single _artifact_ `build.tar.gz`, which contains the sources we are about to build.
This _artifact_ is passed on to any follow up jobs.

[source,yaml]
.ci/checkout-v2.yml
----
checkout-job:    # This job runs in the checkout stage, which runs first.
  stage: checkout
  tags:
    - maven      # signals the maven job runner to pick this up
  allow_failure: false
  script:
    - git clone https://github.com/apache/causeway.git build
    - cd build 
    - git checkout $COMMIT_OR_BRANCH
    - mvn -v
    - mvn versions:set -Drevision=$REVISION
    - cd ..
    - tar --exclude='build/.git' -czf build.tar.gz build
  artifacts:
    paths:
      - build.tar.gz
----

== Test and Deploy

Deploy stage is optional, based on input.

[source,yaml]
.ci/test-and-deploy-causeway-v2.yml
----
test-job: # This job runs in the test stage.
  stage: test    # It only starts when the job in the previous stage completes successfully.
  tags:
    - maven      # signals the maven job runner to pick this up
  dependencies:
    - checkout-job
  allow_failure: false
  script:
    - echo "Testing application with revision $REVISION ..."
    - tar -xzf build.tar.gz
    - ls build
    - cd build
    - mvn -v
    - mkdir -p .mvn
    - |
      mvn verify \
        -Drevision=$REVISION \
        -Dmaven.compiler.release=$JAVA_TARGET_VERSION \
        -Dmaven.compiler.proc=full \
        -Dmaven.source.skip=true \
        -DskipBrowserTests \
        -e -T 4
  artifacts:
    paths:
      - build.tar.gz

deploy-job:      # This job runs in the deploy stage.
  stage: deploy  # It only runs when *both* jobs in the test stage complete successfully.
  tags:
    - maven      # signals the maven job runner to pick this up
  dependencies:
    - test-job
  rules:
    - if: $TEST_OR_DEPLOY == "deploy"
  variables:
    M2_SETTINGS: ${CI_PROJECT_DIR}/ci/m2-settings.xml # assuming this is where we find the Maven settings to use for the deploy stage
  script:
    - echo "Deploying application with revision $REVISION ..."
    - tar -xzf build.tar.gz
    - cd build
    - |
      mvn deploy \
        -s $M2_SETTINGS \
        -Drevision=$REVISION \
        -Dmaven.compiler.release=$JAVA_TARGET_VERSION \
        -Dmaven.compiler.proc=full \
        -DskipBrowserTests \
        -e -T 4
----

== Rename, Test and Deploy Legacy (isis)

Deploy stage is optional, based on input. 
(Same as `Test and Deploy` above, but operating on the renamed sources.)

[source,yaml]
.ci/test-and-deploy-isis-v2.yml
----
rename-job: # This job runs in the rename stage.
  stage: rename    # It only starts when the job in the build stage completes successfully.
  tags:
    - maven      # signals the maven job runner to pick this up
  dependencies:
    - checkout-job
  allow_failure: false
  script:
    - tar -xzf build.tar.gz
    - mv build build-isis
    - cd build-isis
    - |
      export ROOT_PATH_LEGACY=$(pwd)
      jshell scripts/ci/rename-all-published-sources.jsh
    - cd ..
    - tar -czf build-isis.tar.gz build-isis
  artifacts:
    paths:
      - build-isis.tar.gz

test-job-isis: # This job runs in the test stage.
  stage: test    # It only starts when the job in the previous stage completes successfully.
  tags:
    - maven      # signals the maven job runner to pick this up
  dependencies:
    - rename-job
  allow_failure: false
  script:
    - echo "Testing application with revision $REVISION ..."
    - tar -xzf build-isis.tar.gz
    - cd build-isis
    - mvn -v
    - mkdir -p .mvn
    - |
      mvn verify \
        -Drevision=$REVISION \
        -Dmaven.compiler.release=$JAVA_TARGET_VERSION \
        -Dmaven.compiler.proc=full \
        -Dmaven.source.skip=true \
        -DskipBrowserTests \
        -e -T 4
  artifacts:
    paths:
      - build-isis.tar.gz

deploy-job-isis: # This job runs in the deploy stage.
  stage: deploy  # It only runs when *both* jobs in the test stage complete successfully.
  tags:
    - maven      # signals the maven job runner to pick this up
  dependencies:
    - test-job-isis
  rules:
    - if: $TEST_OR_DEPLOY == "deploy"
  variables:
    M2_SETTINGS: ${CI_PROJECT_DIR}/ci/m2-settings.xml # assuming this is where we find the Maven settings to use for the deploy stage
  script:
    - echo "Deploying application with revision $REVISION ..."
    - tar -xzf build-isis.tar.gz
    - cd build-isis
    - |
      mvn deploy \
        -s $M2_SETTINGS \
        -Drevision=$REVISION \
        -Dmaven.compiler.release=$JAVA_TARGET_VERSION \
        -Dmaven.compiler.proc=full \
        -DskipBrowserTests \
        -e -T 4
----