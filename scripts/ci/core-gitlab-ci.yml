#
# This script:
#
# - builds snapshot of isis
#   - pushes to ???
#
# - builds Docker image of demo-app and simple-app
#   -  pushes to hub.docker.com
#
# It requires the following gitlab secret variables
#
# - GCPAPPENGINEREPO_USERNAME
# - GCPAPPENGINEREPO_PASSWORD
# - GCPAPPENGINEREPO_URL
#
# - DOCKER_REGISTRY_USERNAME    # eg "apacheisiscommitters"  (needs to be in the ORG_NAME)
# - DOCKER_REGISTRY_PASSWORD


build all:
  stage: build-package-push
  variables:
     SHARED_VARS_FILE: /builds/apache-isis-committers/apache-isis/ci-env.txt
     MVN_STAGES: deploy
  script:
    # mixins are built first because core (which includes extensions) depend upon them.
    - echo "REVISION=$BASELINE.$(date +%Y%m%d)-$(date +%H%M)-$(echo $CI_COMMIT_SHA | cut -c1-8)" > $SHARED_VARS_FILE
    - sh $CI_SCRIPTS_PATH/build-mixins.sh
    - sh $CI_SCRIPTS_PATH/build-core.sh
    - sh $CI_SCRIPTS_PATH/build-demo-app.sh springboot
    - sh $CI_SCRIPTS_PATH/build-example-apps.sh
